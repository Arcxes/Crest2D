!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Crest={})}(this,function(t){"use strict";var e=function(){function t(t,e){this.canvas=document.createElement("canvas"),this.canvas.id="C2DC",this.canvas.width=t,this.canvas.height=e,this.ctx=this.canvas.getContext("2d"),this.audioContext=new window.AudioContext||new window.webkitAudioContext,window.audioContext=this.audioContext,window.activeSounds={}}var e=t.prototype;return e.create=function(){document.body.appendChild(this.canvas),window.canvas=this.canvas,window.ctx=this.ctx},e.clear=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},e.resize=function(t,e){this.canvas.width=t,this.canvas.height=e},t}(),i=function(){function t(){this.preload=null,this.create=null,this.render=null}var e=t.prototype;return e.start=function(t){t.setCallback(this.internalCreate()),this.preload()},e.registerPreLoad=function(t){this.preload=t},e.registerCreate=function(t){this.start=t},e.registerRender=function(t){this.render=t},e.internalCreate=function(){this.create(),requestAnimationFrame(internalRender)},e.internalRender=function(){this.render(),requestAnimationFrame(this.render)},t}(),n=function(){function t(){}return t.addClickEvent=function(t,e,i){void 0===i&&(i=!1),t.addEventListener("click",e,i),t.addEventListener("touchstart",e,i)},t.removeClickEvent=function(t,e,i){void 0===i&&(i=!1),t.removeEventListener("click",e,i),t.removeEventListener("touchstart",e,i)},t}(),s=function(){function t(){}return t.enableAudioAccess=function(e){try{var i=window.audioContext;if("suspended"==i.state){var t=function t(){i.resume().then(function(){e.removeEventListener("touchstart",t),e.removeEventListener("touchend",t),e.removeEventListener("click",t)})};e.addEventListener("touchstart",t),e.addEventListener("touchend",t),e.addEventListener("click",t)}}catch(t){console.error(t)}},t.makeSource=function(t,e){var i=window.audioContext,n=i.createBufferSource(),s=i.createGain();return s.gain.value=e,n.buffer=t,n.connect(s),s.connect(i.destination),n},t.translateVolume=function(t,e){return e?100*volime:t/100},t.stop=function(t){if(window.activeSounds.hasOwnProperty(t))for(var e in window.activeSounds[t])window.activeSounds[t].hasOwnProperty(e)&&window.activeSounds[t][e].stop()},t.registerSound=function(t,e){window.activeSounds.hasOwnProperty(t)||(window.activeSounds[t]=[]),window.activeSounds[t].push(e)},t}(),o=function(){function t(t,e){this.url=t,this.buffer=e,this.looping=!1,this.volume=1}var e=t.prototype;return e.play=function(){var t=s.makeSource(this.buffer,this.volume);t.loop=this.looping,t.start(),s.registerSound(this.url,t)},e.stop=function(){s.stop(this.url)},e.getVolume=function(){return s.translateVolume(this.volume,!0)},e.setVolume=function(t){this.volume=s.translateVolume(t)},e.setLooping=function(t){this.looping=t},e.isLooping=function(){return this.looping},t}(),r=function(){function t(){this.now=0,this.delta=0,this.then=0}var e=t.prototype;return e.tick=function(){this.now=performance.now(),this.delta=(this.now-this.then)/1e3,this.then=this.now},e.getDelta=function(){return this.delta},t}(),a=function(){function t(){this.ctx=window.ctx}var e=t.prototype;return e.disablePixelBlending=function(){this.ctx.mozImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1},e.setColor=function(t){this.ctx.fillStyle=t},e.setAlpha=function(t){this.ctx.globalAlpha=t},e.setFont=function(t){this.ctx.font=t},e.setLineWidth=function(t){this.ctx.lineWidth=t},e.drawImage=function(t,e,i,n,s){this.ctx.drawImage(t,e,i,n,s)},e.drawText=function(t,e,i){this.ctx.fillText(t,e,i)},e.drawRect=function(t,e,i,n){this.ctx.fillRect(t,e,i,n)},e.drawCircle=function(t,e,i){ctx.beginPath(),ctx.arc(t,e,i,2*Math.PI,!1),ctx.fill()},e.drawStroke=function(t,e,i,n){core.ctx.strokeRect(t,e,i,n)},t}(),h=function(){function t(t,e,i){this.image=t.image,this.cols=t.cols,this.rows=t.rows,this.frameWidth=e||this.image.width/this.cols,this.frameHeight=i||this.image.height/this.rows,this.colIndex=0,this.rowIndex=0,this.ctx=window.ctx}var e=t.prototype;return e.update=function(t){this.colIndex+=t,this.resetModX=Math.floor(this.colIndex%this.cols)},e.draw=function(t,e,i,n){this.ctx.drawImage(this.image,this.resetModX*this.frameWidth,this.rowIndex*this.frameHeight,this.frameWidth,this.frameHeight,t,e,i,n)},e.setFrameRow=function(t){this.rowIndex=t},e.setFrame=function(t,e){this.colIndex=t,this.rowIndex=e,this.resetModX=Math.floor(this.colIndex%this.cols)},t}(),c=function(){function t(t,e,i,n){this.x=t,this.y=e,this.width=i,this.right=this.x+this.width,this.bottom=this.y+this.height}var e=t.prototype;return e.overlaps=function(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y},e.within=function(t){return t.x<=this.x&&t.right>=this.right&&t.y<=this.y&&t.bottom>=this.bottom},e.contains=function(t,e){return t>=this.x&&t<=this.right&&e>=this.y&&e<=this.bottom},e.setPosition=function(t,e){this.x=t,this.y=e},e.setSize=function(t,e){this.width=t,this.height=e},t}(),u=function(){function t(t,e,i){this.x=t,this.y=e,this.radius=i}return t.prototype.overlaps=function(t){return Math.sqrt((this.x-t.x)*(this.x-t.x+(this.y-t.y))*(this.y-t.y))<this.radius+t.radius},t}(),l=function(){this.left=0,this.right=0,this.top=0,this.bottom=0,this.width=0,this.height=0,this.scale={x:0,y:0},this.viewBuffer=100},d=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.position={x:t,y:e},this.distance=1e3,this.fov=Math.PI/4,this.viewport=new l,this.canvas=window.canvas,this.ctx=window.ctx,this.update()}var e=t.prototype;return e.begin=function(){this.ctx.save(),this.applyScale(),this.applyTranslation()},e.end=function(){this.ctx.restore()},e.applyScale=function(){this.ctx.scale(this.viewport.scale.x,this.viewport.scale.y)},e.applyTranslation=function(){this.ctx.translate(-this.viewport.left,-this.viewport.top)},e.update=function(){this.aspectRatio=this.canvas.width/this.canvas.height,this.viewport.width=this.distance*Math.tan(this.fov),this.viewport.height=this.viewport.width/this.aspectRatio,this.viewport.left=this.position.x-this.viewport.width/2,this.viewport.top=this.position.y-this.viewport.height/2,this.viewport.right=this.viewport.left+this.viewport.width,this.viewport.bottom=this.viewport.top+this.viewport.height,this.viewport.scale.x=this.canvas.width/this.viewport.width,this.viewport.scale.y=this.canvas.height/this.viewport.height},e.setZoom=function(t){this.distance=t,this.update()},e.setViewBuffer=function(t){this.viewport.viewBuffer=t},e.setPosition=function(t,e){this.position.x=t,this.position.y=e,this.update()},e.screenToWorld=function(t,e){var i={};return i.x=t/this.viewport.scale.x+this.viewport.left,i.y=e/this.viewport.scale.y+this.viewport.top,i},e.worldToScreen=function(t,e){var i={};return i.x=(t-this.viewport.left)*this.viewport.scale.x,i.y=(e-this.viewport.top)*this.viewport.scale.y,i},e.inView=function(t,e){return t>=this.position.x-this.viewport.viewBuffer&&t<=this.position.x+this.viewport.width+this.viewport.viewBuffer&&e>=this.position.y-this.viewport.viewBuffer&&e<=this.position.y+this.viewport.height+this.viewBuffer},t}(),f=function(){function t(){}return t.prototype.load=function(t,e){var i=new Image;i.addEventListener("load",function(){e.successCount++,e.cache[t]=i,e.isDone()&&e.callback()}),i.addEventListener("error",function(){e.errorCount++,console.error("Failed to load asset: { url: "+t+"}"),e.isDone()&&e.callback()}),i.src=t},t}(),p=function(){function t(t,e){this.url=t,this.data=e,this.tilesets=[],this.tiles=[],this.tiles.push(null),this.image=null,this.x=0,this.y=0,this.totalTiles=0,this.folder=this.url.substring(0,this.url.lastIndexOf("/")),this.success=null,this.error=null,this.ctx=window.ctx}var e=t.prototype;return e.setCallbacks=function(t,e){this.success=t,this.error=e,this.loadTilesets()},e.loadTilesets=function(){for(var i=this,n=this,s=0,o=0,t=function(t){var e=new Image;e.addEventListener("load",function(){s++,n.tilesets.push(e),s+o==n.data.tilesets.length&&n.seperateTiles()}),e.addEventListener("error",function(){o++,console.error("Failed to load: "+n.data.tilesets[t].image),n.error()}),1<=i.folder.length&&(i.folder+="/"),e.src=i.folder+i.data.tilesets[t].image},e=0;e<this.data.tilesets.length;e++)t(e)},e.seperateTiles=function(){for(var t=0;t<this.tilesets.length;t++){var e=this.tilesets[t].width/this.data.tilewidth,i=this.tilesets[t].height/this.data.tileheight;this.totalTiles=e*i;for(var n=0;n<i;n++)for(var s=0;s<e;s++){var o=document.createElement("canvas"),r=o.getContext("2d");o.width=this.data.tilewidth,o.height=this.data.tileheight;var a=s*this.data.tilewidth,h=n*this.data.tileheight;r.drawImage(this.tilesets[t],-a,-h),this.tiles.push(o),this.totalTiles==this.tiles.length-1&&this.preDrawMap()}}},e.predraw=function(){var t=document.createElement("canvas");t.width=this.data.width*this.data.tilewidth,t.height=this.data.height*this.data.tileheight;for(var e=t.getContext("2d"),i=0;i<this.data.layers.length;i++){var n=0,s=0;if("tilelayer"==this.data.layers[i].type)for(var o=0;o<this.data.layers[i].data.length;o++){if(o%this.data.width==0&&0!=o&&(s+=this.data.tileheight,n=0),0!=this.data.layers[i].data[o]){var r=this.tiles[this.data.layers[i].data[o]];e.drawImage(r,n,s)}n+=this.data.tilewidth}}var a=this;this.image=new Image,this.image.addEventListener("load",function(){a.success()}),this.image.addEventListener("error",function(){console.error("Failed to convert map canvas to image"),a.error()}),this.image.src=t.toDataURL("image/png")},e.render=function(){this.ctx.drawImage(this.image,this.x,this.y)},e.setPosition=function(t,e){this.x=t,this.y=e},t}(),w=function(){function t(){}return t.prototype.load=function(i,n){var s=new XMLHttpRequest;s.overrideMimeType("application/json"),s.open("GET",i,!0),s.onload=function(){var t=JSON.parse(s.response);if(console.log(t),null!=t.tiledversion){var e=new p(i,t);console.log(e);e.setCallbacks(function(){n.successCount++,n.cache[i]=e,n.isDone()&&n.callback()},function(){n.errorCount++,console.error("Failed to load asset: { url: "+i+"}"),n.isDone()&&n.callback()})}else n.successCount++,n.cache[i]=t,n.isDone()&&n.callback()},s.onerror=function(){n.errorCount++,console.error("Failed to load asset: { url: "+i+"}"),n.isDone()&&n.callback()},s.send()},t}(),v=function(){function t(){this.context=window.audioContext}return t.prototype.load=function(i,n){var t=new XMLHttpRequest;t.responseType="arraybuffer",t.open("GET",i,!0);var e=this;t.onload=function(){e.context.decodeAudioData(t.response,function(t){if(t){var e=new o(i,t);n.successCount++,n.cache[i]=e,n.isDone()&&n.callback()}else console.error("Failed to load asset: { url: "+i+"}")})},t.onerror=function(){n.errorCount++,console.error("Failed to load asset: { url: "+i+"}"),n.isDone()&&n.callback()},t.send()},t}(),g=function(){function t(){this.successCount=0,this.errorCount=0,this.totalAssets=0,this.cache={},this.queue=[],this.callback=null,this.imageLoader=new f,this.jsonLoader=new w,this.audioLoader=new v}var e=t.prototype;return e.setCallback=function(t){this.callback=t},e.add=function(t){this.totalAssets++,this.queue.push(t)},e.load=function(t){this.totalAssets++;var e=t.split(".");this.loadIntoMemory(t,e[1])},e.loadAssets=function(t){for(var e in null!=t&&this.setCallback(t),this.isDone()&&this.callback(),this.queue){var i=this.queue[e],n=i.split(".");this.loadIntoMemory(i,n[1])}},e.get=function(t){return this.cache[t]},e.loadIntoMemory=function(t,e){"png"==e||"jpg"==e||"jpeg"==e?this.imageLoader.load(t,this):"mp3"==e||"wav"==e||"ogg"==e?this.audioLoader.load(t,this):"json"==e?this.jsonLoader.load(t,this):console.error("Failed to load asset: { url: "+t+"}")},e.isDone=function(){return this.totalAssets==this.successCount+this.errorCount&&(this.totalAssets=0,this.queue=[],!0)},t}();function m(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var y=function(){function t(t){this.socket=null,this.parser=t}var e,i,n,s=t.prototype;return s.connect=function(t){this.socket=new WebSocket(t),this.parser.register(this.socket)},s.send=function(t){this.socket.send(this.parser.encode(t))},s.parse=function(t){return this.parser.decode(t)},e=t,(i=[{key:"onopen",set:function(t){this.socket.onopen=t}},{key:"onmessage",set:function(t){this.socket.onmessage=t}},{key:"onerror",set:function(t){this.socket.onerror=t}},{key:"onclose",set:function(t){this.socket.onclose=t}}])&&m(e.prototype,i),n&&m(e,n),t}(),x=function(){function t(){}var e=t.prototype;return e.register=function(t){console.log("WebSocket: "+t+" has been registered with StringParser")},e.encode=function(t){return t},e.decode=function(t){return t},t}(),b=function(){function t(){}var e=t.prototype;return e.register=function(t){console.log("WebSocket: "+t+" has been registered with JSONParser")},e.encode=function(t){return JSON.stringify(json)},e.decode=function(t){return JSON.parse(t)},t}(),k=function(){function t(){this.byteMultiplier=2}var e=t.prototype;return e.register=function(t){t.binaryType="arraybuffer",console.log("WebSocket: "+t+" has been registered with BinaryParser")},e.encode=function(t){for(var e=JSON.stringify(t),i=new ArrayBuffer(e.length*this.byteMultiplier),n=new Uint16Array(i),s=e.length,o=0;o<s;o++)n[o]=e.charCodeAt(o);return i},e.decode=function(t){var e=String.fromCharCode.apply(null,new Uint16Array(t));return JSON.parse(e)},t}();t.Display=e,t.Application=i,t.InputManager=n,t.AudioDevice=s,t.Audio=o,t.DeltaTime=r,t.SpriteBatch=a,t.SpriteSheet=function(t,e,i){this.image=t,this.cols=e,this.rows=i},t.Animation=h,t.Rectangle=c,t.Circle=u,t.Viewport=l,t.Camera=d,t.Loader=g,t.Client=y,t.StringParser=x,t.JSONParser=b,t.BinaryParser=k,Object.defineProperty(t,"__esModule",{value:!0})});
