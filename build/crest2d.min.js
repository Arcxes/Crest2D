!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i(t.Crest={})}(this,function(t){"use strict";var i=function(){function t(t,i){this.canvas=document.createElement("canvas"),this.canvas.id="C2DC",this.canvas.width=t,this.canvas.height=i,this.ctx=this.canvas.getContext("2d"),this.audioContext=new window.AudioContext||new window.webkitAudioContext,window.audioContext=this.audioContext,window.activeSounds={}}var i=t.prototype;return i.create=function(){document.body.appendChild(this.canvas),window.canvas=this.canvas,window.ctx=this.ctx},i.clear=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},i.resize=function(t,i){this.canvas.width=t,this.canvas.height=i},t}(),e=function(){function t(){this.preload=null,this.create=null,this.render=null}var i=t.prototype;return i.start=function(t){t.setCallback(this.internalCreate()),this.preload()},i.registerPreLoad=function(t){this.preload=t},i.registerCreate=function(t){this.start=t},i.registerRender=function(t){this.render=t},i.internalCreate=function(){this.create(),requestAnimationFrame(internalRender)},i.internalRender=function(){this.render(),requestAnimationFrame(this.render)},t}(),s=function(){function t(){}return t.addClickEvent=function(t,i,e){void 0===e&&(e=!1),t.addEventListener("click",i,e),t.addEventListener("touchstart",i,e)},t.removeClickEvent=function(t,i,e){void 0===e&&(e=!1),t.removeEventListener("click",i,e),t.removeEventListener("touchstart",i,e)},t}(),n=function(){function t(){}return t.enableAudioAccess=function(i){try{var e=window.audioContext;if("suspended"==e.state){var t=function t(){e.resume().then(function(){i.removeEventListener("touchstart",t),i.removeEventListener("touchend",t),i.removeEventListener("click",t)})};i.addEventListener("touchstart",t),i.addEventListener("touchend",t),i.addEventListener("click",t)}}catch(t){console.error(t)}},t.makeSource=function(t,i){var e=window.audioContext,s=e.createBufferSource(),n=e.createGain();return n.gain.value=i,s.buffer=t,s.connect(n),n.connect(e.destination),s},t.translateVolume=function(t,i){return i?100*volime:t/100},t.stop=function(t){if(window.activeSounds.hasOwnProperty(t))for(var i in window.activeSounds[t])window.activeSounds[t].hasOwnProperty(i)&&window.activeSounds[t][i].stop()},t.registerSound=function(t,i){window.activeSounds.hasOwnProperty(t)||(window.activeSounds[t]=[]),window.activeSounds[t].push(i)},t}(),o=function(){function t(t,i){this.url=t,this.buffer=i,this.looping=!1,this.volume=1}var i=t.prototype;return i.play=function(){var t=n.makeSource(this.buffer,this.volume);t.loop=this.looping,t.start(),n.registerSound(this.url,t)},i.stop=function(){n.stop(this.url)},i.getVolume=function(){return n.translateVolume(this.volume,!0)},i.setVolume=function(t){this.volume=n.translateVolume(t)},i.setLooping=function(t){this.looping=t},i.isLooping=function(){return this.looping},t}(),r=function(){function t(){this.now=0,this.delta=0,this.then=0}var i=t.prototype;return i.tick=function(){this.now=performance.now(),this.delta=(this.now-this.then)/1e3,this.then=this.now},i.getDelta=function(){return this.delta},t}(),a=function(){function t(){this.ctx=window.ctx}var i=t.prototype;return i.disablePixelBlending=function(){this.ctx.mozImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1},i.setColor=function(t){this.ctx.fillStyle=t},i.setAlpha=function(t){this.ctx.globalAlpha=t},i.setFont=function(t){this.ctx.font=t},i.setLineWidth=function(t){this.ctx.lineWidth=t},i.drawImage=function(t,i,e,s,n){this.ctx.drawImage(t,i,e,s,n)},i.drawText=function(t,i,e){this.ctx.fillText(t,i,e)},i.drawRect=function(t,i,e,s){this.ctx.fillRect(t,i,e,s)},i.drawCircle=function(t,i,e){ctx.beginPath(),ctx.arc(t,i,e,2*Math.PI,!1),ctx.fill()},i.drawStroke=function(t,i,e,s){core.ctx.strokeRect(t,i,e,s)},t}(),h=function(){function t(t,i,e){this.image=t.image,this.cols=t.cols,this.rows=t.rows,this.frameWidth=i||this.image.width/this.cols,this.frameHeight=e||this.image.height/this.rows,this.colIndex=0,this.rowIndex=0,this.ctx=window.ctx}var i=t.prototype;return i.update=function(t){this.colIndex+=t,this.resetModX=Math.floor(this.colIndex%this.cols)},i.draw=function(t,i,e,s){this.ctx.drawImage(this.image,this.resetModX*this.frameWidth,this.rowIndex*this.frameHeight,this.frameWidth,this.frameHeight,t,i,e,s)},i.setFrameRow=function(t){this.rowIndex=t},i.setFrame=function(t,i){this.colIndex=t,this.rowIndex=i,this.resetModX=Math.floor(this.colIndex%this.cols)},t}(),c=function(){function t(t,i,e,s){this.x=t,this.y=i,this.width=e,this.right=this.x+this.width,this.bottom=this.y+this.height}var i=t.prototype;return i.overlaps=function(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y},i.within=function(t){return t.x<=this.x&&t.right>=this.right&&t.y<=this.y&&t.bottom>=this.bottom},i.contains=function(t,i){return t>=this.x&&t<=this.right&&i>=this.y&&i<=this.bottom},i.setPosition=function(t,i){this.x=t,this.y=i},i.setSize=function(t,i){this.width=t,this.height=i},t}(),u=function(){function t(t,i,e){this.x=t,this.y=i,this.radius=e}return t.prototype.overlaps=function(t){return Math.sqrt((this.x-t.x)*(this.x-t.x+(this.y-t.y))*(this.y-t.y))<this.radius+t.radius},t}(),l=function(){this.left=0,this.right=0,this.top=0,this.bottom=0,this.width=0,this.height=0,this.scale={x:0,y:0},this.viewBuffer=100},d=function(){function t(t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.position={x:t,y:i},this.distance=1e3,this.fov=Math.PI/4,this.viewport=new l,this.canvas=window.canvas,this.ctx=window.ctx,this.update()}var i=t.prototype;return i.begin=function(){this.ctx.save(),this.applyScale(),this.applyTranslation()},i.end=function(){this.ctx.restore()},i.applyScale=function(){this.ctx.scale(this.viewport.scale.x,this.viewport.scale.y)},i.applyTranslation=function(){this.ctx.translate(-this.viewport.left,-this.viewport.top)},i.update=function(){this.aspectRatio=this.canvas.width/this.canvas.height,this.viewport.width=this.distance*Math.tan(this.fov),this.viewport.height=this.viewport.width/this.aspectRatio,this.viewport.left=this.position.x-this.viewport.width/2,this.viewport.top=this.position.y-this.viewport.height/2,this.viewport.right=this.viewport.left+this.viewport.width,this.viewport.bottom=this.viewport.top+this.viewport.height,this.viewport.scale.x=this.canvas.width/this.viewport.width,this.viewport.scale.y=this.canvas.height/this.viewport.height},i.setZoom=function(t){this.distance=t,this.update()},i.setViewBuffer=function(t){this.viewport.viewBuffer=t},i.setPosition=function(t,i){this.position.x=t,this.position.y=i,this.update()},i.screenToWorld=function(t,i){var e={};return e.x=t/this.viewport.scale.x+this.viewport.left,e.y=i/this.viewport.scale.y+this.viewport.top,e},i.worldToScreen=function(t,i){var e={};return e.x=(t-this.viewport.left)*this.viewport.scale.x,e.y=(i-this.viewport.top)*this.viewport.scale.y,e},i.inView=function(t,i){return t>=this.position.x-this.viewport.viewBuffer&&t<=this.position.x+this.viewport.width+this.viewport.viewBuffer&&i>=this.position.y-this.viewport.viewBuffer&&i<=this.position.y+this.viewport.height+this.viewBuffer},t}(),f=function(){function t(){}return t.prototype.load=function(t,i){var e=new Image;e.addEventListener("load",function(){i.successCount++,i.cache[t]=e,i.isDone()&&i.callback()}),e.addEventListener("error",function(){i.errorCount++,console.error("Failed to load asset: { url: "+t+"}"),i.isDone()&&i.callback()}),e.src=t},t}(),p=function(){function t(t,i){this.url=t,this.data=i,this.tilesets=[],this.tiles=[],this.tiles.push(null),this.image=null,this.x=0,this.y=0,this.totalTiles=0,this.folder=this.url.substring(0,this.url.lastIndexOf("/")),this.success=null,this.error=null,this.ctx=window.ctx}var i=t.prototype;return i.setCallbacks=function(t,i){this.success=t,this.error=i,this.loadTilesets()},i.loadTilesets=function(){for(var e=this,s=this,n=0,o=0,t=function(t){var i=new Image;i.addEventListener("load",function(){n++,s.tilesets.push(i),n+o==s.data.tilesets.length&&s.seperateTiles()}),i.addEventListener("error",function(){o++,console.error("Failed to load: "+s.data.tilesets[t].image),s.error()}),1<=e.folder.length&&(e.folder+="/"),i.src=e.folder+e.data.tilesets[t].image},i=0;i<this.data.tilesets.length;i++)t(i)},i.seperateTiles=function(){for(var t=0;t<this.tilesets.length;t++){var i=this.tilesets[t].width/this.data.tilewidth,e=this.tilesets[t].height/this.data.tileheight;this.totalTiles=i*e;for(var s=0;s<e;s++)for(var n=0;n<i;n++){var o=document.createElement("canvas"),r=o.getContext("2d");o.width=this.data.tilewidth,o.height=this.data.tileheight;var a=n*this.data.tilewidth,h=s*this.data.tileheight;r.drawImage(this.tilesets[t],-a,-h),this.tiles.push(o),this.totalTiles==this.tiles.length-1&&this.preDrawMap()}}},i.predraw=function(){var t=document.createElement("canvas");t.width=this.data.width*this.data.tilewidth,t.height=this.data.height*this.data.tileheight;for(var i=t.getContext("2d"),e=0;e<this.data.layers.length;e++){var s=0,n=0;if("tilelayer"==this.data.layers[e].type)for(var o=0;o<this.data.layers[e].data.length;o++){if(o%this.data.width==0&&0!=o&&(n+=this.data.tileheight,s=0),0!=this.data.layers[e].data[o]){var r=this.tiles[this.data.layers[e].data[o]];i.drawImage(r,s,n)}s+=this.data.tilewidth}}var a=this;this.image=new Image,this.image.addEventListener("load",function(){a.success()}),this.image.addEventListener("error",function(){console.error("Failed to convert map canvas to image"),a.error()}),this.image.src=t.toDataURL("image/png")},i.render=function(){this.ctx.drawImage(this.image,this.x,this.y)},i.setPosition=function(t,i){this.x=t,this.y=i},t}(),w=function(){function t(){}return t.prototype.load=function(e,s){var n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET",e,!0),n.onload=function(){var t=JSON.parse(n.response);if(console.log(t),null!=t.tiledversion){var i=new p(e,t);console.log(i);i.setCallbacks(function(){s.successCount++,s.cache[e]=i,s.isDone()&&s.callback()},function(){s.errorCount++,console.error("Failed to load asset: { url: "+e+"}"),s.isDone()&&s.callback()})}else s.successCount++,s.cache[e]=t,s.isDone()&&s.callback()},n.onerror=function(){s.errorCount++,console.error("Failed to load asset: { url: "+e+"}"),s.isDone()&&s.callback()},n.send()},t}(),v=function(){function t(){this.context=window.audioContext}return t.prototype.load=function(e,s){var t=new XMLHttpRequest;t.responseType="arraybuffer",t.open("GET",e,!0);var i=this;t.onload=function(){i.context.decodeAudioData(t.response,function(t){if(t){var i=new o(e,t);s.successCount++,s.cache[e]=i,s.isDone()&&s.callback()}else console.error("Failed to load asset: { url: "+e+"}")})},t.onerror=function(){s.errorCount++,console.error("Failed to load asset: { url: "+e+"}"),s.isDone()&&s.callback()},t.send()},t}(),g=function(){function t(){this.successCount=0,this.errorCount=0,this.totalAssets=0,this.cache={},this.queue=[],this.callback=null,this.imageLoader=new f,this.jsonLoader=new w,this.audioLoader=new v}var i=t.prototype;return i.setCallback=function(t){this.callback=t},i.add=function(t){this.totalAssets++,this.queue.push(t)},i.load=function(t){this.totalAssets++;var i=t.split(".");this.loadIntoMemory(t,i[1])},i.loadAssets=function(t){for(var i in null!=t&&this.setCallback(t),this.isDone()&&this.callback(),this.queue){var e=this.queue[i],s=e.split(".");this.loadIntoMemory(e,s[1])}},i.get=function(t){return this.cache[t]},i.loadIntoMemory=function(t,i){"png"==i||"jpg"==i||"jpeg"==i?this.imageLoader.load(t,this):"mp3"==i||"wav"==i||"ogg"==i?this.audioLoader.load(t,this):"json"==i?this.jsonLoader.load(t,this):console.error("Failed to load asset: { url: "+t+"}")},i.isDone=function(){return this.totalAssets==this.successCount+this.errorCount&&(this.totalAssets=0,this.queue=[],!0)},t}();t.Display=i,t.Application=e,t.InputManager=s,t.AudioDevice=n,t.Audio=o,t.DeltaTime=r,t.SpriteBatch=a,t.SpriteSheet=function(t,i,e){this.image=t,this.cols=i,this.rows=e},t.Animation=h,t.Rectangle=c,t.Circle=u,t.Viewport=l,t.Camera=d,t.Loader=g,Object.defineProperty(t,"__esModule",{value:!0})});
