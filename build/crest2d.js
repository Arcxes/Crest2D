//Copyright 2019 Arcxes Games. Crest2D
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Crest={})}(this,function(t){"use strict";var e=function(t,e){this.canvas=document.createElement("canvas"),this.canvas.id="C2DC",this.canvas.width=t,this.canvas.height=e,this.ctx=this.canvas.getContext("2d")};e.prototype.create=function(){document.body.appendChild(this.canvas),window.canvas=this.canvas,window.ctx=this.ctx},e.prototype.clear=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},e.prototype.resize=function(t,e){this.canvas.width=t,this.canvas.height=e};var i=function(){this.preload=null,this.create=null,this.render=null};i.prototype.start=function(t){t.setCallback(this.internalCreate()),this.preload()},i.prototype.registerPreLoad=function(t){this.preload=t},i.prototype.registerCreate=function(t){this.start=t},i.prototype.registerRender=function(t){this.render=t},i.prototype.internalCreate=function(){this.create(),requestAnimationFrame(internalRender)},i.prototype.internalRender=function(){this.render(),requestAnimationFrame(this.render)};var o=function(){};o.addClickEvent=function(t,e,i){void 0===i&&(i=!1),t.addEventListener("click",e,i),t.addEventListener("touchstart",e,i)},o.removeClickEvent=function(t,e,i){void 0===i&&(i=!1),t.removeEventListener("click",e,i),t.removeEventListener("touchstart",e,i)};var s=function(){this.now=0,this.delta=0,this.then=0};s.prototype.tick=function(){this.now=performance.now(),this.delta=(this.now-this.then)/1e3,this.then=this.now},s.prototype.getDelta=function(){return this.delta};var n=function(){this.ctx=window.ctx};n.prototype.disablePixelBlending=function(){this.ctx.mozImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1},n.prototype.setColor=function(t){this.ctx.fillStyle=t},n.prototype.setAlpha=function(t){this.ctx.globalAlpha=t},n.prototype.setFont=function(t){this.ctx.font=t},n.prototype.setLineWidth=function(t){this.ctx.lineWidth=t},n.prototype.drawImage=function(t,e,i,o,s){this.ctx.drawImage(t,e,i,o,s)},n.prototype.drawText=function(t,e,i){this.ctx.fillText(t,e,i)},n.prototype.drawRect=function(t,e,i,o){this.ctx.fillRect(t,e,i,o)},n.prototype.drawCircle=function(t,e,i){ctx.beginPath(),ctx.arc(t,e,i,2*Math.PI,!1),ctx.fill()},n.prototype.drawStroke=function(t,e,i,o){core.ctx.strokeRect(t,e,i,o)};var r=function(t,e,i){this.image=t.image,this.cols=t.cols,this.rows=t.rows,this.frameWidth=e||this.image.width/this.cols,this.frameHeight=i||this.image.height/this.rows,this.colIndex=0,this.rowIndex=0,this.ctx=window.ctx};r.prototype.update=function(t){this.colIndex+=t,this.resetModX=Math.floor(this.colIndex%this.cols)},r.prototype.draw=function(t,e,i,o){this.ctx.drawImage(this.image,this.resetModX*this.frameWidth,this.rowIndex*this.frameHeight,this.frameWidth,this.frameHeight,t,e,i,o)},r.prototype.setFrameRow=function(t){this.rowIndex=t},r.prototype.setFrame=function(t,e){this.colIndex=t,this.rowIndex=e,this.resetModX=Math.floor(this.colIndex%this.cols)};var a=function(t,e,i,o){this.x=t,this.y=e,this.width=i,this.right=this.x+this.width,this.bottom=this.y+this.height};a.prototype.overlaps=function(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y},a.prototype.within=function(t){return t.x<=this.x&&t.right>=this.right&&t.y<=this.y&&t.bottom>=this.bottom},a.prototype.contains=function(t,e){return t>=this.x&&t<=this.right&&e>=this.y&&e<=this.bottom},a.prototype.setPosition=function(t,e){this.x=t,this.y=e},a.prototype.setSize=function(t,e){this.width=t,this.height=e};var h=function(t,e,i){this.x=t,this.y=e,this.radius=i};h.prototype.overlaps=function(t){return Math.sqrt((this.x-t.x)*(this.x-t.x+(this.y-t.y))*(this.y-t.y))<this.radius+t.radius};var c=function(){this.left=0,this.right=0,this.top=0,this.bottom=0,this.width=0,this.height=0,this.scale={x:0,y:0},this.viewBuffer=100},l=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.position={x:t,y:e},this.distance=1e3,this.fov=Math.PI/4,this.viewport=new c,this.canvas=window.canvas,this.ctx=window.ctx,this.update()};l.prototype.begin=function(){this.ctx.save(),this.applyScale(),this.applyTranslation()},l.prototype.end=function(){this.ctx.restore()},l.prototype.applyScale=function(){this.ctx.scale(this.viewport.scale.x,this.viewport.scale.y)},l.prototype.applyTranslation=function(){this.ctx.translate(-this.viewport.left,-this.viewport.top)},l.prototype.update=function(){this.aspectRatio=this.canvas.width/this.canvas.height,this.viewport.width=this.distance*Math.tan(this.fov),this.viewport.height=this.viewport.width/this.aspectRatio,this.viewport.left=this.position.x-this.viewport.width/2,this.viewport.top=this.position.y-this.viewport.height/2,this.viewport.right=this.viewport.left+this.viewport.width,this.viewport.bottom=this.viewport.top+this.viewport.height,this.viewport.scale.x=this.canvas.width/this.viewport.width,this.viewport.scale.y=this.canvas.height/this.viewport.height},l.prototype.setZoom=function(t){this.distance=t,this.update()},l.prototype.setViewBuffer=function(t){this.viewport.viewBuffer=t},l.prototype.setPosition=function(t,e){this.position.x=t,this.position.y=e,this.update()},l.prototype.screenToWorld=function(t,e){var i={};return i.x=t/this.viewport.scale.x+this.viewport.left,i.y=e/this.viewport.scale.y+this.viewport.top,i},l.prototype.worldToScreen=function(t,e){var i={};return i.x=(t-this.viewport.left)*this.viewport.scale.x,i.y=(e-this.viewport.top)*this.viewport.scale.y,i},l.prototype.inView=function(t,e){return t>=this.position.x-this.viewport.viewBuffer&&t<=this.position.x+this.viewport.width+this.viewport.viewBuffer&&e>=this.position.y-this.viewport.viewBuffer&&e<=this.position.y+this.viewport.height+this.viewBuffer};var p=function(){};p.prototype.load=function(t,e){var i=new Image;i.addEventListener("load",function(){e.successCount++,e.cache[t]=i,e.isDone()&&e.callback()}),i.addEventListener("error",function(){e.errorCount++,console.error("Failed to load asset: { url: "+t+"}"),e.isDone()&&e.callback()}),i.src=t};var u=function(t,e){this.url=t,this.data=e,this.tilesets=[],this.tiles=[],this.tiles.push(null),this.image=null,this.x=0,this.y=0,this.totalTiles=0,this.folder=this.url.substring(0,this.url.lastIndexOf("/")),this.success=null,this.error=null,this.ctx=window.ctx};u.prototype.setCallbacks=function(t,e){this.success=t,this.error=e,this.loadTilesets()},u.prototype.loadTilesets=function(){for(var i=this,o=this,s=0,n=0,t=function(t){var e=new Image;e.addEventListener("load",function(){s++,o.tilesets.push(e),s+n==o.data.tilesets.length&&o.seperateTiles()}),e.addEventListener("error",function(){n++,console.error("Failed to load: "+o.data.tilesets[t].image),o.error()}),1<=i.folder.length&&(i.folder+="/"),e.src=i.folder+i.data.tilesets[t].image},e=0;e<i.data.tilesets.length;e++)t(e)},u.prototype.seperateTiles=function(){for(var t=0;t<this.tilesets.length;t++){var e=this.tilesets[t].width/this.data.tilewidth,i=this.tilesets[t].height/this.data.tileheight;this.totalTiles=e*i;for(var o=0;o<i;o++)for(var s=0;s<e;s++){var n=document.createElement("canvas"),r=n.getContext("2d");n.width=this.data.tilewidth,n.height=this.data.tileheight;var a=s*this.data.tilewidth,h=o*this.data.tileheight;r.drawImage(this.tilesets[t],-a,-h),this.tiles.push(n),this.totalTiles==this.tiles.length-1&&this.predraw()}}},u.prototype.predraw=function(){var t=document.createElement("canvas");t.width=this.data.width*this.data.tilewidth,t.height=this.data.height*this.data.tileheight;for(var e=t.getContext("2d"),i=0;i<this.data.layers.length;i++){var o=0,s=0;if("tilelayer"==this.data.layers[i].type)for(var n=0;n<this.data.layers[i].data.length;n++){if(n%this.data.width==0&&0!=n&&(s+=this.data.tileheight,o=0),0!=this.data.layers[i].data[n]){var r=this.tiles[this.data.layers[i].data[n]];e.drawImage(r,o,s)}o+=this.data.tilewidth}}var a=this;this.image=new Image,this.image.addEventListener("load",function(){a.success()}),this.image.addEventListener("error",function(){console.error("Failed to convert map canvas to image"),a.error()}),this.image.src=t.toDataURL("image/png")},u.prototype.render=function(){this.ctx.drawImage(this.image,this.x,this.y)},u.prototype.setPosition=function(t,e){this.x=t,this.y=e};var d=function(){};d.prototype.load=function(i,o){var s=new XMLHttpRequest;s.overrideMimeType("application/json"),s.open("GET",i,!0),s.onload=function(){var t=JSON.parse(s.response);if(console.log(t),null!=t.tiledversion){var e=new u(i,t);console.log(e);e.setCallbacks(function(){o.successCount++,o.cache[i]=e,o.isDone()&&o.callback()},function(){o.errorCount++,console.error("Failed to load asset: { url: "+i+"}"),o.isDone()&&o.callback()})}else o.successCount++,o.cache[i]=t,o.isDone()&&o.callback()},s.onerror=function(){o.errorCount++,console.error("Failed to load asset: { url: "+i+"}"),o.isDone()&&o.callback()},s.send()};var f=function(){};f.enableAudioAccess=function(t){try{var e=window.audioContext;if("suspended"==e.state){var i=function(){e.resume().then(function(){t.removeEventListener("touchstart",i),t.removeEventListener("touchend",i),t.removeEventListener("click",i)})};t.addEventListener("touchstart",i),t.addEventListener("touchend",i),t.addEventListener("click",i)}}catch(t){console.error(t)}},f.makeSource=function(t,e){var i=window.audioContext,o=i.createBufferSource(),s=i.createGain();return s.gain.value=e,o.buffer=t,o.connect(s),s.connect(i.destination),o},f.translateVolume=function(t,e){return e?100*volime:t/100},f.stop=function(t){if(window.activeSounds.hasOwnProperty(t))for(var e in window.activeSounds[t])window.activeSounds[t].hasOwnProperty(e)&&window.activeSounds[t][e].stop()},f.registerSound=function(t,e){window.activeSounds.hasOwnProperty(t)||(window.activeSounds[t]=[]),window.activeSounds[t].push(e)};var v=function(t,e){this.url=t,this.buffer=e,this.looping=!1,this.volume=1};v.prototype.play=function(){var t=f.makeSource(this.buffer,this.volume);t.loop=this.looping,t.start(),f.registerSound(this.url,t)},v.prototype.stop=function(){f.stop(this.url)},v.prototype.getVolume=function(){return f.translateVolume(this.volume,!0)},v.prototype.setVolume=function(t){this.volume=f.translateVolume(t)},v.prototype.setLooping=function(t){this.looping=t},v.prototype.isLooping=function(){return this.looping};var w=function(){this.context=window.audioContext};w.prototype.load=function(i,o){var t=new XMLHttpRequest;t.responseType="arraybuffer",t.open("GET",i,!0);var e=this;t.onload=function(){e.context.decodeAudioData(t.response,function(t){if(t){var e=new v(i,t);o.successCount++,o.cache[i]=e,o.isDone()&&o.callback()}else console.error("Failed to load asset: { url: "+i+"}")})},t.onerror=function(){o.errorCount++,console.error("Failed to load asset: { url: "+i+"}"),o.isDone()&&o.callback()},t.send()};var y=function(){this.successCount=0,this.errorCount=0,this.totalAssets=0,this.cache={},this.queue=[],this.callback=null,this.imageLoader=new p,this.jsonLoader=new d,this.audioLoader=new w};y.prototype.setCallback=function(t){this.callback=t},y.prototype.add=function(t){this.totalAssets++,this.queue.push(t)},y.prototype.load=function(t){this.totalAssets++;var e=t.split(".");this.loadIntoMemory(t,e[1])},y.prototype.loadAssets=function(t){for(var e in null!=t&&this.setCallback(t),this.isDone()&&this.callback(),this.queue){var i=this.queue[e],o=i.split(".");this.loadIntoMemory(i,o[1])}},y.prototype.get=function(t){return this.cache[t]},y.prototype.loadIntoMemory=function(t,e){"png"==e||"jpg"==e||"jpeg"==e?this.imageLoader.load(t,this):"mp3"==e||"wav"==e||"ogg"==e?this.audioLoader.load(t,this):"json"==e?this.jsonLoader.load(t,this):console.error("Failed to load asset: { url: "+t+"}")},y.prototype.isDone=function(){return this.totalAssets==this.successCount+this.errorCount&&(this.totalAssets=0,this.queue=[],!0)};var g=function(t){this.socket=null,this.parser=t},m={onopen:{configurable:!0},onmessage:{configurable:!0},onerror:{configurable:!0},onclose:{configurable:!0}};g.prototype.connect=function(t){this.socket=new WebSocket(t),this.parser.register(this.socket)},g.prototype.send=function(t){this.socket.send(this.parser.encode(t))},g.prototype.parse=function(t){return this.parser.decode(t)},m.onopen.set=function(t){this.socket.onopen=t},m.onmessage.set=function(t){this.socket.onmessage=t},m.onerror.set=function(t){this.socket.onerror=t},m.onclose.set=function(t){this.socket.onclose=t},Object.defineProperties(g.prototype,m);var x=function(){};x.prototype.register=function(t){console.log("WebSocket: "+t+" has been registered with StringParser")},x.prototype.encode=function(t){return t},x.prototype.decode=function(t){return t};var b=function(){};b.prototype.register=function(t){console.log("WebSocket: "+t+" has been registered with JSONParser")},b.prototype.encode=function(t){return JSON.stringify(t)},b.prototype.decode=function(t){return JSON.parse(t)};var C=function(){this.byteMultiplier=2};C.prototype.register=function(t){t.binaryType="arraybuffer",console.log("WebSocket: "+t+" has been registered with BinaryParser")},C.prototype.encode=function(t){for(var e=JSON.stringify(t),i=new ArrayBuffer(e.length*this.byteMultiplier),o=new Uint16Array(i),s=e.length,n=0;n<s;n++)o[n]=e.charCodeAt(n);return i},C.prototype.decode=function(t){var e=String.fromCharCode.apply(null,new Uint16Array(t));return JSON.parse(e)},t.Display=e,t.Application=i,t.InputManager=o,t.DeltaTime=s,t.SpriteBatch=n,t.SpriteSheet=function(t,e,i){this.image=t,this.cols=e,this.rows=i},t.Animation=r,t.Rectangle=a,t.Circle=h,t.Viewport=c,t.Camera=l,t.Loader=y,t.Client=g,t.StringParser=x,t.JSONParser=b,t.BinaryParser=C,Object.defineProperty(t,"__esModule",{value:!0})});
